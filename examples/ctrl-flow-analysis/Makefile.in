PACKAGE = ctrl-flow-analysis
LIBVERSION = 0.1

SRCDIR		= @srcdir@
TOP_SRCDIR	= @top_srcdir@
SUBDIR		= examples/ctrl-flow-analysis
OBJDIR		= @top_builddir@

SUBDIRS = 

include $(OBJDIR)/Makeconf

CFLAGS += -I$(OBJDIR) \
	  -I$(TOP_SRCDIR)/lib \
	  -I$(TOP_SRCDIR)/include \
	  -I$(TOP_SRCDIR)/dwdebug \
	  -I$(TOP_SRCDIR)/target \
      -I$(TOP_SRCDIR)/examples/context-aware-probes \
	  -I$(TOP_SRCDIR)/$(SUBDIR)

CFLAGS += -DDWDEBUG_USE_STRTAB
CFLAGS += $(ELFUTILS_CFLAGS) $(GLIB_CFLAGS)
ifeq ($(ENABLE_XENACCESS),"1")
	CFLAGS += -D ENABLE_XENACCESS $(XENACCESS_FLAGS)
	CFLAGS += -I$(XENACCESS_INC)
endif
ifeq ($(ENABLE_DISTORM),"1")
	CFLAGS += -D ENABLE_DISTORM -D SUPPORT_64BIT_OFFSET 
	CFLAGS += -I$(DISTORM)/include
endif

LDFLAGS += $(ELFUTILS_LDFLAGS) $(GLIB_LDFLAGS)
ifeq ($(ENABLE_XENACCESS),"1")
	LDFLAGS += -lxenctrl -lxenstore -lc -L$(XENACCESS_LIBDIR)
endif
ifeq ($(ENABLE_DISTORM),"1")
	LDFLAGS += -L$(DISTORM)/lib -ldistorm3
endif

HEADERS := $(TOP_SRCDIR)/$(SUBDIR)/debug.h

OBJECTS := 

LIBRARIES := 

PROGRAMS := ctrl-flow-static \
            ctrl-flow-passwd \
            ctrl-flow-root

STATICLIBS := $(OBJDIR)/examples/context-aware-probes/ctxprobes.a \
              $(OBJDIR)/target/libtarget.a \
              $(OBJDIR)/dwdebug/libdwdebug.a \
              $(OBJDIR)/lib/libvmilib.a
ifeq ($(ENABLE_XENACCESS),"1")
	STATICLIBS += $(XENACCESS_A)
endif

INST_INC = 
INST_LIB = $(LIBRARIES)

# Get libtool to shut up when compiling.
RM=rm -f

all:	$(PROGRAMS) all-subdirs

include $(TOP_SRCDIR)/Makerules

.c.lo:	$(HEADERS)
	@$(LIBTOOL) --tag=CC --mode=compile ${CC} ${CFLAGS} -c $<

ctrl-flow-static: $(HEADERS) $(LIBRARIES) $(OBJECTS) ctrl-flow-static.lo $(STATICLIBS)
	$(LIBTOOL) --mode=link \
	$(CC) -o $@ $(CFLAGS) $(OBJECTS) $@.o $(LIBRARIES) $(STATICLIBS) $(LDFLAGS)

ctrl-flow-passwd: $(HEADERS) $(LIBRARIES) $(OBJECTS) ctrl-flow-passwd.lo $(STATICLIBS)
	$(LIBTOOL) --mode=link \
	$(CC) -o $@ $(CFLAGS) $(OBJECTS) $@.o $(LIBRARIES) $(STATICLIBS) $(LDFLAGS)

ctrl-flow-root: $(HEADERS) $(LIBRARIES) $(OBJECTS) ctrl-flow-root.lo $(STATICLIBS)
	$(LIBTOOL) --mode=link \
	$(CC) -o $@ $(CFLAGS) $(OBJECTS) $@.o $(LIBRARIES) $(STATICLIBS) $(LDFLAGS)

install: def-install install-subdirs
	$(SUDO) $(CP) -fd libdwdebug.so $(DESTDIR)$(INSTALL_LIBDIR)/

clean: clean-subdirs
	@$(LIBTOOL) --mode=clean rm -f $(OBJECTS) \
	ctrl-flow-static.lo \
	ctrl-flow-passwd.lo \
	ctrl-flow-root.lo
	$(RM) -f $(PROGRAMS)

distclean: distclean-subdirs

run-static: ctrl-flow-static
	sudo ./ctrl-flow-static -m /boot/System.map-2.6.18-xenU \
	clientA

demo-static: ctrl-flow-static
	sudo ./ctrl-flow-static -m /boot/System.map-2.6.18-xenU \
	clientA 2> /dev/null

verbose-static: ctrl-flow-static
	sudo ./ctrl-flow-static -ddddddddddd -l T_ALL,P_ALL,T_XV \
	-m /boot/System.map-2.6.18-xenU \
	clientA

debug-static: ctrl-flow-static
	sudo gdb --args ./ctrl-flow-static -ddddddddddd -l T_ALL,P_ALL,T_XV \
	-m /boot/System.map-2.6.18-xenU \
	clientA

run-passwd: ctrl-flow-passwd
	sudo ./ctrl-flow-passwd -m /boot/System.map-2.6.18-xenU \
	clientA

demo-passwd: ctrl-flow-passwd
	sudo ./ctrl-flow-passwd -m /boot/System.map-2.6.18-xenU \
	clientA 2> /dev/null

verbose-passwd: ctrl-flow-passwd
	sudo ./ctrl-flow-passwd -ddddddddddd -l T_ALL,P_ALL,T_XV \
	-m /boot/System.map-2.6.18-xenU \
	clientA

debug-passwd: ctrl-flow-passwd
	sudo gdb --args ./ctrl-flow-passwd -ddddddddddd -l T_ALL,P_ALL,T_XV \
	-m /boot/System.map-2.6.18-xenU \
	clientA

run-root: ctrl-flow-root
	sudo ./ctrl-flow-root -m /boot/System.map-2.6.18-xenU \
	-p 293 -b 435417843 \
	clientA

demo-root: ctrl-flow-root
	sudo ./ctrl-flow-root -m /boot/System.map-2.6.18-xenU \
	-p 293 -b 435417843 \
	clientA 2> /dev/null

verbose-root: ctrl-flow-root
	sudo ./ctrl-flow-root -ddddddddddd -l T_ALL,P_ALL,T_XV \
	-m /boot/System.map-2.6.18-xenU \
	-p 293 -b 435417843 \
	clientA

debug-root: ctrl-flow-root
	sudo gdb --args ./ctrl-flow-root -ddddddddddd -l T_ALL,P_ALL,T_XV \
	-m /boot/System.map-2.6.18-xenU \
	-p 293 -b 435417843 \
	clientA

# How to recursively descend into subdirectories to make general
# targets such as `all'.
%.MAKE:
	@$(MAKE) -C $(dir $@) $(basename $(notdir $@))
%-subdirs: $(addsuffix /%.MAKE,$(SUBDIRS)) ;

.PHONY:	$(SUBDIRS)

.SECONDARY:
