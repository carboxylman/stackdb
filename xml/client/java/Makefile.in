## -*- mode: Makefile -*-
##
## Copyright (c) 2013 The University of Utah
##
## This program is free software; you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation; either version 2 of
## the License, or (at your option) any later version.
##
## This program is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with this program; if not, write to the Free Software
## Foundation, 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA.

###############################################################################

SRCDIR		= @srcdir@
TOP_SRCDIR	= @top_srcdir@
SUBDIR		= xml/client/java
OBJDIR		= @top_builddir@

SUBDIRS = 

include $(OBJDIR)/Makeconf

NS=http://anathema.flux.utah.edu/schema/vmi/1

PACKAGE = vmi1

JAVA = @JAVA@
JAVAC = @JAVAC@
JAR = @JAR@
JAVA_HOME = @JAVA_HOME@

AXIS2_HOME = @AXIS2_HOME@
AXIS2_CLASSPATH := $(shell JAVA_HOME=$(JAVA_HOME) AXIS2_HOME=$(AXIS2_HOME) $(SRCDIR)/dump_axis2_env.sh | grep AXIS2_CLASSPATH= | sed -e s/AXIS2_CLASSPATH=//)

AXIS2_DB :=  "adb"
#AXIS2_DB := "jaxbri"
#AXIS2_DB :=  "jibx"
#
# Adjust classpath stuff for different databindings.
#
ifeq ($(AXIS2_DB),"jaxbri")
    BUILD_CLASSPATH := @abs_builddir@/debuginfo/build/lib/Debuginfo-test-client.jar:@abs_builddir@/target/build/lib/Target-test-client.jar
else
#@abs_builddir@/debuginfo/build/lib/debuginfo.jar:@abs_builddir@/target/build/lib/target.jar:@abs_builddir@/target-extra/build/lib/target-extra.jar:
    BUILD_CLASSPATH := @abs_builddir@/debuginfo/build/classes:@abs_builddir@/target/build/classes:@abs_builddir@/target-extra/build/classes
endif
RUN_CLASSPATH := @abs_builddir@/debuginfo-all.jar:@abs_builddir@/target-all.jar
#
# Only enable if you are using adb and want validation disabled.  For now,
# we default to this because ADB without validation does not work with our 
# schemas.
#
AXIS2_DB_OPTS := 
ifeq ($(AXIS2_DB),"adb")
    AXIS2_DB_OPTS := -Eosv
endif

ANT = @ANT@

ifneq ($(CLASSPATH),"")
    BUILD_CLASSPATH := $(AXIS2_CLASSPATH):$(BUILD_CLASSPATH):$(CLASSPATH)
    RUN_CLASSPATH := $(AXIS2_CLASSPATH):$(RUN_CLASSPATH):$(CLASSPATH)
else
    BUILD_CLASSPATH := $(AXIS2_CLASSPATH):$(BUILD_CLASSPATH)
    RUN_CLASSPATH := $(AXIS2_CLASSPATH):$(RUN_CLASSPATH)
endif

STUBS = debuginfo/src/$(PACKAGE)/DebuginfoStub.java \
	target/src/$(PACKAGE)/TargetStub.java
SERVERSTUBS = target/src/$(PACKAGE)/TargetListenerSkeleton.java
JARS =  debuginfo/build/lib/debuginfo.jar debuginfo-all.jar \
	target/build/lib/target.jar target-extra/build/lib/target-extra.jar \
	target-all.jar

TARGET_LIBS = SimpleService.class SimpleServiceServer.class \
	      SimpleTargetListener.class

PROGRAMS = DebuginfoTest.class TargetTest.class 

all:	run.sh $(PROGRAMS) $(JARS) all-subdirs

include $(TOP_SRCDIR)/Makerules

run.sh:
	echo "#!/bin/sh" > $@
	echo "" >> $@
	echo "$(JAVA) -classpath $(RUN_CLASSPATH) \\" >> $@
	echo "    -Djava.endorsed.dirs=${AXIS2_HOME}/lib/endorsed:$(JAVA_HOME)/jre/lib/endorsed:$(JAVA_HOME)/lib/endorsed \\" >> $@
#	echo "    -Djava.security.manager \\" >> $@
#	echo "    -Djava.security.policy=$(AXIS2_HOME)/conf/axis2.policy \\"
	echo "    -Daxis2.home=$(AXIS2_HOME) \\" >> $@
	echo "    -Dsun.lang.ClassLoader.allowArraySyntax=true \\" >> $@
	echo '    $$@' >> $@
	chmod ug+x $@

debuginfo/src/$(PACKAGE)/DebuginfoStub.java: $(OBJDIR)/xml/service/debuginfo.wsdl.test
	mkdir -p debuginfo
	JAVA_HOME=$(JAVA_HOME) AXIS2_HOME=$(AXIS2_HOME) \
		${AXIS2_HOME}/bin/wsdl2java.sh -d $(AXIS2_DB) $(AXIS2_DB_OPTS) \
		 -o debuginfo -ns2p $(NS)=vmi1 -p $(PACKAGE) -or -u -uri $<

target/src/$(PACKAGE)/TargetListenerSkeleton.java: $(OBJDIR)/xml/service/targetListener.wsdl.test
	mkdir -p target
	rm -f target/build.xml
	JAVA_HOME=$(JAVA_HOME) AXIS2_HOME=$(AXIS2_HOME) \
		${AXIS2_HOME}/bin/wsdl2java.sh -d $(AXIS2_DB) $(AXIS2_DB_OPTS) \
		-o target -ns2p $(NS)=vmi1 -p $(PACKAGE) -or -ss -uri $<

target/src/$(PACKAGE)/TargetStub.java: $(OBJDIR)/xml/service/target.wsdl.test
	mkdir -p target
	rm -f target/build.xml
	JAVA_HOME=$(JAVA_HOME) AXIS2_HOME=$(AXIS2_HOME) \
		${AXIS2_HOME}/bin/wsdl2java.sh -d $(AXIS2_DB) $(AXIS2_DB_OPTS) \
		 -o target -ns2p $(NS)=vmi1 -p $(PACKAGE) -or -u -uri $<

debuginfo/build/lib/debuginfo.aar: debuginfo/src/$(PACKAGE)/DebuginfoStub.java
	(JAVA_HOME=$(JAVA_HOME) CLASSPATH=$(BUILD_CLASSPATH) \
		AXIS2_HOME=$(AXIS2_HOME) AXIS2_CLASSPATH=$(AXIS2_CLASSPATH) \
		$(ANT) -buildfile debuginfo/build.xml jar.all)

debuginfo/build/lib/debuginfo.jar: debuginfo/build/lib/debuginfo.aar
	cp -p $< $@

debuginfo-all.jar: debuginfo/build/lib/debuginfo.jar
	cp -p $< $@

target/build/lib/target.aar: target/src/$(PACKAGE)/TargetListenerSkeleton.java \
		target/src/$(PACKAGE)/TargetStub.java 
	(JAVA_HOME=$(JAVA_HOME) CLASSPATH=$(BUILD_CLASSPATH) \
		AXIS2_HOME=$(AXIS2_HOME) AXIS2_CLASSPATH=$(AXIS2_CLASSPATH) \
		$(ANT) -buildfile target/build.xml jar.all)

target/build/lib/target.jar: target/build/lib/target.aar
	cp -p $< $@

target-all.jar: target/build/lib/target.jar target-extra/build/lib/target-extra.jar
	rm -f $@
	jar -cf $@ -C target/build/classes/ vmi1 -C target resources
	jar -uf $@ -C target-extra/build/ vmi1 

target-extra/build/$(PACKAGE)/%.class: $(SRCDIR)/%.java
	mkdir -p target-extra/build/vmi1
	$(JAVAC) -classpath $(BUILD_CLASSPATH):target-extra/build -d target-extra/build/ $<

target-extra/build/lib/target-extra.jar: $(addprefix target-extra/build/$(PACKAGE)/,$(TARGET_LIBS)) \
		target/build/lib/target.jar
	rm -rf target-extra/build/lib
	mkdir -p target-extra/build/lib
	(JAVA_HOME=$(JAVA_HOME) CLASSPATH=$(BUILD_CLASSPATH) \
		AXIS2_HOME=$(AXIS2_HOME) AXIS2_CLASSPATH=$(AXIS2_CLASSPATH) \
		$(JAR) cvf $@ -C target-extra/build vmi1)

DebuginfoTest.class: DebuginfoTest.java debuginfo/build/lib/debuginfo.aar
	$(JAVAC) -classpath $(BUILD_CLASSPATH) DebuginfoTest.java

TargetTest.class: TargetTest.java target/build/lib/target.aar
	$(JAVAC) -classpath $(BUILD_CLASSPATH) TargetTest.java

install: def-install install-subdirs

clean: clean-subdirs
	rm -rf $(STUBS) $(SERVERSTUBS) 
	rm -f $(PROGRAMS) $(JARS)
	rm -rf debuginfo target target-extra
	rm -f run.sh

distclean: distclean-subdirs

# How to recursively descend into subdirectories to make general
# targets such as `all'.
%.MAKE:
	@$(MAKE) -C $(dir $@) $(basename $(notdir $@))
%-subdirs: $(addsuffix /%.MAKE,$(SUBDIRS)) ;

.PHONY:	$(SUBDIRS)

.SECONDARY:
