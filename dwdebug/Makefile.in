PACKAGE = dwdebug
VERSION = 0.1
LIBVERSION = 0.1

SRCDIR		= @srcdir@
TOP_SRCDIR	= @top_srcdir@
SUBDIR		= dwdebug
OBJDIR		= @top_builddir@

SUBDIRS = 

include $(OBJDIR)/Makeconf

LCFLAGS := -I$(SRCDIR) -I$(TOP_SRCDIR)/lib -I$(TOP_SRCDIR)/include -I$(OBJDIR)
LCFLAGS += -DDWDEBUG_USE_STRTAB
LCFLAGS += $(ELFUTILS_CFLAGS) $(GLIB_CFLAGS)

CFLAGS += $(LCFLAGS)
PYCFLAGS += -I@PYTHON_INCLUDE@ $(LCFLAGS)

LDFLAGS += $(ELFUTILS_LDFLAGS) $(GLIB_LDFLAGS)

HEADERS := $(SRCDIR)/dwdebug.h \
	$(TOP_SRCDIR)/include/list.h $(TOP_SRCDIR)/include/alist.h \
	$(TOP_SRCDIR)/include/common.h $(TOP_SRCDIR)/include/log.h \
	$(TOP_SRCDIR)/include/output.h

OBJECTS := debug.lo dwarf_debuginfo.lo dwarf_elfutils.lo 
LIBRARIES := libdwdebug.a libdwdebug.so.$(LIBVERSION)
STATICLIBS := $(OBJDIR)/lib/libvlog.a libdwdebug.a
DYNAMICLIBS := $(OBJDIR)/lib/libvlog.so libdwdebug.so
SWIGLIBS := _dwdebug.so

PROGRAMS := dumpdebuginfo

INST_INC = dwdebug.h
INST_LIB = $(LIBRARIES) $(SWIGLIBS)

# Get libtool to shut up when compiling.
RM=rm -f

all:	$(LIBRARIES) libdwdebug.so $(SWIGLIBS) $(PROGRAMS) all-subdirs

include $(TOP_SRCDIR)/Makerules

.c.lo:	$(HEADERS)
	$(LIBTOOL) --tag=CC --mode=compile ${CC} ${CFLAGS} -c $<

libdwdebug.a:	$(HEADERS) $(OBJECTS)
	@$(LIBTOOL) --tag=CC --mode=link $(CC) -o libdwdebug.a $(OBJECTS)

dwdebug.lo:	$(HEADERS) $(OBJECTS)
	@$(LIBTOOL) --tag=CC --mode=link ${CC} -shared -o $@ $(OBJECTS)

libdwdebug.so.$(LIBVERSION):	dwdebug.lo
	$(CP) -f dwdebug.lo $@

libdwdebug.so:	libdwdebug.so.$(LIBVERSION)
	$(LN_S) $< $@

dwdebug_wrap_py.c: $(SRCDIR)/dwdebug.i $(SRCDIR)/dwdebug.h #$(SRCDIR)/dwdebug.py.tail
	swig -python $(PYCFLAGS) -o dwdebug_wrap_py.c -module dwdebug \
		$(SRCDIR)/dwdebug.i
	#cat $(SRCDIR)/dwdebug.py.tail >> dwdebug.py
	#touch $@

dwdebug_wrap_py.o: dwdebug_wrap_py.c $(SRCDIR)/dwdebug.h
	$(CC) -fPIC -c $(PYCFLAGS) $<

_dwdebug.so:	dwdebug_wrap_py.o
	ld -shared $^ $(DYNAMICLIBS) $(LDFLAGS) -o $@

dumpdebuginfo: $(HEADERS) $(LIBRARIES) dumpdebuginfo.lo $(STATICLIBS)
	$(CC) -o $@ $(CFLAGS) $@.o $(STATICLIBS) $(LDFLAGS)

install: def-install install-subdirs
	$(SUDO) $(CP) -fd dwdebug.so $(DESTDIR)$(INSTALL_LIBDIR)/

clean: clean-subdirs
	@$(LIBTOOL) --mode=clean rm -f $(OBJECTS) \
		dwdebug.lo targetdumpval.lo dumpdebuginfo.lo
	$(RM) -f $(LIBRARIES) dwdebug.o libdwdebug.so libdwdebug.so.$(LIBVERSION) 
	$(RM) -f dwdebug.py* dwdebug_wrap_py.* _dwdebug.so
	$(RM) -f $(PROGRAMS)

distclean: distclean-subdirs

# How to recursively descend into subdirectories to make general
# targets such as `all'.
%.MAKE:
	@$(MAKE) -C $(dir $@) $(basename $(notdir $@))
%-subdirs: $(addsuffix /%.MAKE,$(SUBDIRS)) ;

.PHONY:	$(SUBDIRS)

.SECONDARY:
